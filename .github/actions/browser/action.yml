name: 'Run Test On Browser'
description: 'Setup Browser and Run Test'
inputs:
  browsers:
    description: 'List of browser name'
    required: true
  mode:
    description: 'Test mode'
    required: false
    default: 'affected' # affected|all
  coverage:
    description: 'Include test covertage'
    required: false
    default: 'true'
  parallel:
    description: 'Run parallel testing limit'
    required: false
    # Default value 3 is OK for every browsers except Safari need to be one to make it stable
    default: 1
  base:
    description: 'Base sha for test affected mode'
    required: false
  browserstack:
    description: 'Run test on BrowserStack'
    required: false
    default: 'false'
  username:
    description: 'BrowserStack username'
    required: false
  access-key:
    description: 'BrowserStack access key'
    required: false
runs:
  using: "composite"
  steps:
    # - name: 'BrowserStack Env Setup' # Invokes the setup-env action
    #   if: ${{ inputs.browserstack == 'true' }}
    #   uses: browserstack/github-actions/setup-env@master
    #   with:
    #     username: ${{ inputs.username }}
    #     access-key: ${{ inputs.access-key }}

    # - name: 'BrowserStack Local Tunnel Setup' # Invokes the setup-local action
    #   if: ${{ inputs.browserstack == 'true' }}
    #   uses: browserstack/github-actions/setup-local@master
    #   with:
    #     local-testing: start
    #     local-identifier: random

    - name: Setup resources and environment
      uses: ./.github/actions/setup
      id: setup

    - name: Create browsers command line option
      shell:
      run: |
        echo "From Secret Setting: ${{ inputs.browserstack }}"
        [[ "${{ inputs.browserstack }}" == "true" ]] && export BROWSER="browserstack" || export BROWSER="browsers"
        echo "BROWSER is: $BROWSER"
        echo "export BROWSER_OPTION=\"--$BROWSER=\"${{ inputs.browsers }}\"\""
        export BROWSER_OPTION="--$BROWSER=\"${{ inputs.browsers }}\""
        echo "BROWSER_OPTION='--$BROWSER=\"${{ inputs.browsers }}\"'" >> $GITHUB_ENV
        echo "Use Option on Local: "
        echo "$BROWSER_OPTION"
        echo "Use Option on GitHub: "
        echo "${{ env.BROWSER_OPTION }}"

    - name: Create browsers command line option
      shell:
      run: |
        echo "${{ env.BROWSER_OPTION }}"
        echo "DONE"

    # - name: Test All
    #   if: ${{ inputs.mode == 'all' }}
    #   shell: bash
    #   # Prevent NX caching because it must run all testing, even though the code has not chaged.
    #   run: npm run test:all -- --parallel=${{ inputs.parallel }} --skip-nx-cache ${{ env.BROWSER_OPTION }} --includeCoverage ${{ inputs.coverage }} --output minimal

    # - name: Test Affected
    #   if: ${{ inputs.mode == 'affected' }}
    #   shell: bash
    #   # Parallel need to be 1 because Safari not stable when run parallel more than 1
    #   run: npm run test:affected -- --base=${{ inputs.base }} --parallel=${{ inputs.parallel }} ${{ env.BROWSER_OPTION }} --includeCoverage ${{ inputs.coverage }} --output minimal

    # - name: BrowserStackLocal Stop  # Terminating the BrowserStackLocal tunnel connection
    #   if: ${{ inputs.browserstack == 'true' }}
    #   uses: browserstack/github-actions/setup-local@master
    #   with:
    #     local-testing: stop



